<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Forest Inventory – Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:system-ui,sans-serif; background:#f4f6f5; }
header { background:#2f6f4e; color:#fff; padding:10px; display:flex; gap:10px; }
header button { background:rgba(255,255,255,.2); border:none; color:#fff; padding:6px 10px; border-radius:4px; }
main { padding:12px; }
.card { background:#fff; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #ddd; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:10px; }
button { padding:6px 10px; border:none; border-radius:4px; background:#4f8f6f; color:#fff; cursor:pointer; }
button.danger { background:#c0392b; }
button.secondary { background:#777; }
input, textarea { width:100%; margin:4px 0; padding:6px; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
td { background:#fff; }
td[contenteditable] { background:#fdfefe; }
.actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
#map { height:300px; margin-top:10px; }
.hidden { display:none; }
</style>
</head>

<body>

<header>
  <button id="backBtn" class="hidden">◀ Back</button>
  <strong id="title">Projects</strong>
</header>

<main id="app"></main>

<script>
/* ============================================================
   IndexedDB
============================================================ */
const DB_NAME = "forest_inventory_db";
const DB_VERSION = 1;
let db;

function openDB() {
  return new Promise((resolve) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      db = e.target.result;
      db.createObjectStore("projects", { keyPath: "id" });
    };
    req.onsuccess = e => { db = e.target.result; resolve(); };
  });
}

function tx(store, mode="readonly") {
  return db.transaction(store, mode).objectStore(store);
}

function idbRequest(req) {
  return new Promise((resolve, reject) => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function uid() {
  return crypto.randomUUID();
}

/* ============================================================
   State & Navigation
============================================================ */
let nav = { view:"projects" };
const app = document.getElementById("app");
const title = document.getElementById("title");
const backBtn = document.getElementById("backBtn");

backBtn.onclick = () => { nav = nav.prev; render(); };

function setView(v) { nav = {...v, prev:nav}; render(); }

/* ============================================================
   Rendering
============================================================ */
async function render() {
  app.innerHTML = "";
  backBtn.classList.toggle("hidden", nav.view === "projects");

  if (nav.view === "projects") renderProjects();
  if (nav.view === "project") renderProject();
  if (nav.view === "plots") renderPlots();
  if (nav.view === "trees") renderTrees();
  if (nav.view === "logs") renderLogs();
}

/* ============================================================
   Projects
============================================================ */
async function renderProjects() {
  title.textContent = "Projects";
  const store = tx("projects");
  const projects = await idbRequest(store.getAll());

  const grid = document.createElement("div");
  grid.className = "grid";

  projects.forEach(p => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<h3>${p.name || "Unnamed"}</h3>
      <small>${p.plots.length} plots</small>`;
    c.onclick = () => setView({view:"project", id:p.id});
    grid.appendChild(c);
  });

  const add = document.createElement("button");
  add.textContent = "+ New Project";
  add.onclick = async () => {
    const project = {
      id: uid(),
      name: "",
      notes: "",
      polygon: null,
      plots: []
    };
    await idbRequest(tx("projects", "readwrite").add(project));
    render();
  };

  app.append(grid, add);
}

/* ============================================================
   Project + Geometry Editor
============================================================ */
async function renderProject() {
  title.textContent = "Project";
  const p = await idbRequest(tx("projects").get(nav.id));

  app.innerHTML = `
    <input placeholder="Project Name" value="${p.name}">
    <textarea placeholder="Notes">${p.notes}</textarea>
    <div id="map"></div>
    <div class="actions">
      <button id="plotsBtn">Plots</button>
      <button id="exportJSON">Export JSON</button>
      <button id="exportCSV">Export CSV</button>
      <button class="danger" id="del">Delete</button>
    </div>
  `;

  const [name, notes] = app.querySelectorAll("input,textarea");
  name.oninput = notes.oninput = () => {
    p.name = name.value; p.notes = notes.value;
    tx("projects","readwrite").put(p);
  };

  initMap(p);

  document.getElementById("plotsBtn").onclick =
    () => setView({view:"plots", id:p.id});

  document.getElementById("del").onclick = async () => {
    if(confirm("Delete project?")) {
      tx("projects","readwrite").delete(p.id);
      nav = {view:"projects"};
      render();
    }
  };

  document.getElementById("exportJSON").onclick = () => exportJSON(p);
  document.getElementById("exportCSV").onclick = () => exportCSV(p);
}

/* ============================================================
   Geometry Map Editor
============================================================ */
function initMap(project) {
  const map = L.map("map").setView([45, -120], 6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  let polygon;
  if(project.polygon) {
    polygon = L.geoJSON(project.polygon).addTo(map);
    map.fitBounds(polygon.getBounds());
  }

  map.on("click", e => {
    if(!polygon) {
      polygon = L.polygon([[e.latlng.lat,e.latlng.lng]]).addTo(map);
    } else {
      polygon.addLatLng(e.latlng);
    }
    project.polygon = polygon.toGeoJSON();
    tx("projects","readwrite").put(project);
  });
}

/* ============================================================
   Plots
============================================================ */
async function renderPlots() {
  title.textContent = "Plots";
  const p = await idbRequest(tx("projects").get(nav.id));

  p.plots.forEach(plot => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <input placeholder="Plot ID" value="${plot.name}">
      <div class="actions">
        <button>Trees</button>
        <button class="danger">Delete</button>
      </div>
    `;

    c.querySelector("input").oninput = e => {
      plot.name = e.target.value;
      tx("projects","readwrite").put(p);
    };

    c.querySelector("button").onclick =
      () => setView({view:"trees", pid:p.id, plotId:plot.id});

    c.querySelector(".danger").onclick = () => {
      if(confirm("Delete plot?")) {
        p.plots = p.plots.filter(x=>x!==plot);
        tx("projects","readwrite").put(p);
        render();
      }
    };
    app.appendChild(c);
  });

  const add = document.createElement("button");
  add.textContent = "+ Add Plot";
  add.onclick = () => {
    p.plots.push({id:uid(), name:"", trees:[]});
    tx("projects","readwrite").put(p);
    render();
  };
  app.appendChild(add);
}

/* ============================================================
   Spreadsheet Trees
============================================================ */
async function renderTrees() {
  title.textContent = "Trees";
  const p = await idbRequest(tx("projects").get(nav.pid));
  const plot = p.plots.find(pl=>pl.id===nav.plotId);

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>#</th><th>Species</th><th>DBH</th><th>Ht</th><th>Logs</th><th>❌</th>
    </tr>
  `;

  plot.trees.forEach(tree => {
    const r = document.createElement("tr");
    r.innerHTML = `
      <td contenteditable>${tree.number}</td>
      <td contenteditable>${tree.species}</td>
      <td contenteditable>${tree.dbh}</td>
      <td contenteditable>${tree.height}</td>
      <td><button>Logs</button></td>
      <td><button class="danger">X</button></td>
    `;

    r.querySelectorAll("td[contenteditable]").forEach((td,i)=>{
      const keys=["number","species","dbh","height"];
      td.onblur=()=>{ tree[keys[i]]=td.textContent; tx("projects","readwrite").put(p); };
    });

    r.querySelector("button").onclick =
      () => setView({view:"logs", pid:p.id, plotId:plot.id, treeId:tree.id});

    r.querySelector(".danger").onclick = () => {
      plot.trees = plot.trees.filter(t=>t!==tree);
      tx("projects","readwrite").put(p);
      render();
    };
    table.appendChild(r);
  });

  const add = document.createElement("button");
  add.textContent = "+ Add Tree";
  add.onclick = () => {
    plot.trees.push({id:uid(), number:"", species:"", dbh:"", height:"", logs:[]});
    tx("projects","readwrite").put(p);
    render();
  };

  app.append(table, add);
}

/* ============================================================
   Spreadsheet Logs
============================================================ */
async function renderLogs() {
  title.textContent = "Logs";
  const p = await idbRequest(tx("projects").get(nav.pid));
  const plot = p.plots.find(pl=>pl.id===nav.plotId);
  const tree = plot.trees.find(t=>t.id===nav.treeId);

  const table = document.createElement("table");
  table.innerHTML = `
    <tr><th>#</th><th>Length</th><th>Dia</th><th>Grade</th><th>❌</th></tr>
  `;

  tree.logs.forEach(log=>{
    const r=document.createElement("tr");
    r.innerHTML=`
      <td contenteditable>${log.number}</td>
      <td contenteditable>${log.length}</td>
      <td contenteditable>${log.diameter}</td>
      <td contenteditable>${log.grade}</td>
      <td><button class="danger">X</button></td>
    `;
    r.querySelectorAll("td[contenteditable]").forEach((td,i)=>{
      const keys=["number","length","diameter","grade"];
      td.onblur=()=>{ log[keys[i]]=td.textContent; tx("projects","readwrite").put(p); };
    });
    r.querySelector(".danger").onclick=()=>{
      tree.logs=tree.logs.filter(l=>l!==log);
      tx("projects","readwrite").put(p);
      render();
    };
    table.appendChild(r);
  });

  const add=document.createElement("button");
  add.textContent="+ Add Log";
  add.onclick=()=>{
    tree.logs.push({id:uid(),number:"",length:"",diameter:"",grade:""});
    tx("projects","readwrite").put(p);
    render();
  };

  app.append(table,add);
}

/* ============================================================
   Export
============================================================ */
function exportJSON(project) {
  download(JSON.stringify(project,null,2), "project.json");
}

function exportCSV(project) {
  let rows=["project,plot,tree,log,species,dbh,height,length,diameter,grade"];
  project.plots.forEach(pl=>{
    pl.trees.forEach(t=>{
      t.logs.forEach(l=>{
        rows.push([
          project.name,pl.name,t.number,l.number,
          t.species,t.dbh,t.height,l.length,l.diameter,l.grade
        ].join(","));
      });
    });
  });
  download(rows.join("\n"),"inventory.csv");
}

function download(text,name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([text]));
  a.download=name;
  a.click();
}

/* ============================================================
   Init
============================================================ */
openDB().then(render);
</script>
</body>
</html>
